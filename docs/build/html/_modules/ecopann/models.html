

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ecopann.models &mdash; ECoPANN 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> ECoPANN
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickStart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_reference.html">Package Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_history.html">Release History</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ECoPANN</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ecopann.models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ecopann.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">data_processor</span> <span class="k">as</span> <span class="n">dp</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">data_simulator</span> <span class="k">as</span> <span class="n">ds</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">train</span><span class="p">,</span> <span class="n">evaluate</span><span class="p">,</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">fcnet</span><span class="p">,</span> <span class="n">hpmodel</span><span class="p">,</span> <span class="n">nodeframe</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">import</span> <span class="nn">torch.multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1">#%% multilayer perceptron (MLP)</span>
<div class="viewcode-block" id="MLP"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP">[docs]</a><span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Train</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multilayer perceptron (MLP) that is used to predict cosmological parameters with one set of datasets.</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectra : array-like</span>
<span class="sd">        The simulated observational spectra (data) with shape (N, spectra_length).</span>
<span class="sd">    parameters : array-like</span>
<span class="sd">        The simulated parameters of a specific cosmological (or theoretical) model.</span>
<span class="sd">    param_names : list</span>
<span class="sd">        A list which contains the parameter names, e.g. [&#39;H0&#39;,&#39;Omega_m&#39;,&#39;ombh2&#39;,&#39;omch2&#39;,&#39;tau&#39;,&#39;As&#39;,&#39;ns&#39;].</span>
<span class="sd">    params_dict : dict or None, optional</span>
<span class="sd">        Information of cosmological parameters that include the labels, the base values, the minimum values, </span>
<span class="sd">        and the maximum values. See :func:`~.cosmic_params.params_dict_zoo`. Default: None</span>
<span class="sd">    obs_errors : array-like, optional</span>
<span class="sd">        Observational errors with shape (spectra_length,). Default: None</span>
<span class="sd">    cov_matrix : array-like or None, optional</span>
<span class="sd">        Covariance matrix of the observational data. Default: None</span>
<span class="sd">    hidden_layer : int, optional</span>
<span class="sd">        The number of the hidden layer of the network. Default: 3</span>
<span class="sd">    hp_model : str, optional</span>
<span class="sd">        Hyperparameter model that contains hyperparameters (such as activation function, batch normalization, dropout, etc.) used in the network.</span>
<span class="sd">        It can be &#39;eco_1&#39;, &#39;eco_2&#39;, &#39;eco_3&#39;, &#39;eco_4&#39;, &#39;eco_5&#39;, &#39;eco_6&#39;, or &#39;eco_7&#39; (see :func:`~.hpmodel.models`). Default: &#39;eco_3&#39;</span>
<span class="sd">    loss_func : str, optional</span>
<span class="sd">        The loss function used in the network. Default: &#39;L1&#39;</span>
<span class="sd">    noise_type : str, optional</span>
<span class="sd">        The type of Gaussian noise added to the training set, &#39;singleSigma&#39; or &#39;multiSigma&#39;. Default: &#39;multiSigma&#39;</span>
<span class="sd">    noise_sigma : float, optional</span>
<span class="sd">        For the case of &#39;singleSigma&#39;, it is the standard deviation of the Gaussian noise, while for the case of &#39;multiSigma&#39; it is </span>
<span class="sd">        a coefficient of the standard deviation. Default: 0.5</span>
<span class="sd">    multi_noise : int, optional</span>
<span class="sd">        The number of realization of noise added to a spectrum. Default: 5</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    lr : float, optional</span>
<span class="sd">        The learning rate setting of the network. Default: 1e-2</span>
<span class="sd">    lr_min : float, optional</span>
<span class="sd">        The minimum of the learning rate. Default: 1e-8</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        The batch size setting of the network. Default: 750</span>
<span class="sd">    auto_batchSize : bool, optional</span>
<span class="sd">        If True, the batch size will be set automatically in the training process, otherwise, use the setting of ``batch_size``. Default: True</span>
<span class="sd">    epoch : int, optional</span>
<span class="sd">        The number of epoch of the training process. Default: 2000</span>
<span class="sd">    base_epoch : int, optional</span>
<span class="sd">        The base number (or the minimum number) of epoch. Default: 1000</span>
<span class="sd">    auto_epoch : bool, optional</span>
<span class="sd">        If True, the epoch will be set automatically in the training process, otherwise, use the setting of ``epoch``. Default: True</span>
<span class="sd">    norm_inputs : bool, optional</span>
<span class="sd">        If True, the input data of the network will be normalized. Default: True</span>
<span class="sd">    norm_target : bool, optional</span>
<span class="sd">        If True, the target data (cosmological parameters) will be normalized. Default: True</span>
<span class="sd">    norm_type : str, optional</span>
<span class="sd">        The method of normalization, &#39;z_score&#39;, &#39;minmax&#39;, or &#39;mean&#39; (see :class:`~.data_processor.Normalize`). Default: &#39;z_score&#39;</span>
<span class="sd">    spaceSigma_min : int, optional</span>
<span class="sd">        The minimum parameter space to be learned, e.g. for spaceSigma_min=5, the parameter space to be learned is :math:`[-5\sigma, +5\sigma]`. Default: 5</span>
<span class="sd">    transfer_learning : bool, optional</span>
<span class="sd">        If True, the network will be initialized using the well-trained network of the previous step. Default: False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obs_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">hidden_layer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">hp_model</span><span class="o">=</span><span class="s1">&#39;eco_3&#39;</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span>
                 <span class="n">noise_type</span><span class="o">=</span><span class="s1">&#39;multiSigma&#39;</span><span class="p">,</span> <span class="n">noise_sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">multi_noise</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1">#data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParamsScaling</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="n">params_dict</span><span class="p">)</span><span class="o">.</span><span class="n">scaling</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span> <span class="o">=</span> <span class="n">params_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span> <span class="o">=</span> <span class="n">obs_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">cov_matrix</span>
        <span class="c1">#ANN model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer</span> <span class="o">=</span> <span class="n">hidden_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp_model</span> <span class="o">=</span> <span class="n">hp_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loss_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">750</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_batchSize</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_epoch</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_epoch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_initialize</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_info</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#data preprocessing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span> <span class="o">=</span> <span class="n">noise_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span> <span class="o">=</span> <span class="n">noise_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span> <span class="o">=</span> <span class="n">multi_noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">=</span> <span class="s1">&#39;z_score&#39;</span>
        <span class="c1">#training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spaceSigma_min</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_repeat_n</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">burn_in</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">burnIn_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_learning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span><span class="o">/</span><span class="mf">5.</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nodeframe</span><span class="o">.</span><span class="n">decreasingNode</span><span class="p">(</span><span class="n">node_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_in</span><span class="p">,</span><span class="n">node_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_out</span><span class="p">,</span><span class="n">hidden_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_net</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_initialize</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="c1">#Fixed parameter initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hparams</span> <span class="o">=</span> <span class="n">hpmodel</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">get_FcNet</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_info</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_check_batchSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The batch size is set to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_auto_batchSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn_in</span><span class="p">:</span>
            <span class="c1">#here &lt;=2.5 is based on experiments</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaceSigma_min</span><span class="o">&lt;=</span><span class="mf">2.5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="c1">#make sure batch size will not too large</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="o">&gt;</span><span class="mi">1250</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1250</span>
    
    <span class="k">def</span> <span class="nf">_auto_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn_in</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_epoch</span>
    
    <span class="k">def</span> <span class="nf">_auto_repeat_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat_n</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn_in</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">repeat_n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
    
<div class="viewcode-block" id="MLP.statistic"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.statistic">[docs]</a>    <span class="k">def</span> <span class="nf">statistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">)</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span></div>

<div class="viewcode-block" id="MLP.load_wellTrainedNet"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.load_wellTrainedNet">[docs]</a>    <span class="k">def</span> <span class="nf">load_wellTrainedNet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="s1">&#39;0.123&#39;</span><span class="p">):</span>
        <span class="n">randn_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Loading the well trained network that has random number </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">randn_num</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="n">randn_num</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_net</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_learning</span> <span class="o">=</span> <span class="kc">True</span></div>
    
<div class="viewcode-block" id="MLP.copyLayers_fromTrainedNet"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.copyLayers_fromTrainedNet">[docs]</a>    <span class="k">def</span> <span class="nf">copyLayers_fromTrainedNet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Copying hyperparameters of a well trained network to the network&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trained_net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">())</span></div>

<div class="viewcode-block" id="MLP.transfer_data"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.transfer_data">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MLP.train"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">showIter_n</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_net</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_learning</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyLayers_fromTrainedNet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_net</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Adam&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_batchSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_batchSize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_batchSize</span><span class="p">()</span>
        <span class="c1"># print(&#39;batch size: %s&#39;%self.batch_size)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_epoch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_epoch</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_repeat_n</span><span class="p">:</span>
            <span class="n">repeat_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_repeat_n</span><span class="p">(</span><span class="n">repeat_n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">repeat_n</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_data</span><span class="p">()</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># np.random.seed(1000)#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;randn_num: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subsample_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">AddMultiGaussianNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">obs_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">,</span><span class="n">cov_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span><span class="n">multi_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="p">,</span><span class="n">use_GPU</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">)</span><span class="o">.</span><span class="n">multiNoisySample</span><span class="p">(</span><span class="n">noise_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span><span class="p">,</span><span class="n">reorder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">loss_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">repeat_n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">set_seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lr_decay</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">+=</span> <span class="n">loss_</span>
            <span class="k">if</span> <span class="n">subsample_num</span><span class="o">%</span><span class="n">showIter_n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(epoch:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">; loss:</span><span class="si">%.5f</span><span class="s1">; lr:</span><span class="si">%.8f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">loss_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]))</span>
            <span class="n">lrdc</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LrDecay</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span><span class="n">iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span><span class="n">lr_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrdc</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span></div>
    
<div class="viewcode-block" id="MLP.predict"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#for one spectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span><span class="p">:</span>
            <span class="n">spectra</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="n">in_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">InverseNormalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">inverseNorm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParamsScaling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span><span class="p">)</span><span class="o">.</span><span class="n">inverseScaling</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span></div>
    
<div class="viewcode-block" id="MLP.predict_chain"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.predict_chain">[docs]</a>    <span class="k">def</span> <span class="nf">predict_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_spectra</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain_leng</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="c1"># torch.manual_seed(1000)#</span>
        <span class="n">obs_spectra</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">)</span>
        <span class="n">obs_best</span><span class="p">,</span> <span class="n">obs_errors</span> <span class="o">=</span> <span class="n">obs_spectra</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">obs_spectra</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">obs_best_multi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">chain_leng</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_best</span><span class="p">)))</span> <span class="o">*</span> <span class="n">obs_best</span>
        <span class="k">if</span> <span class="n">cov_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
        <span class="n">obs_best_multi</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">AddGaussianNoise</span><span class="p">(</span><span class="n">obs_best_multi</span><span class="p">,</span> <span class="n">obs_errors</span><span class="o">=</span><span class="n">obs_errors</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">=</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">use_GPU</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">singleSigma</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">obs_best_multi</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="s1">&#39;torch&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span></div>

<div class="viewcode-block" id="MLP.save_net"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.save_net">[docs]</a>    <span class="k">def</span> <span class="nf">save_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;net_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pt&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;net-</span><span class="si">%s</span><span class="s1">_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">saveTorchPt</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MLP.save_loss"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.save_loss">[docs]</a>    <span class="k">def</span> <span class="nf">save_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;loss_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;loss-</span><span class="si">%s</span><span class="s1">_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">savenpy</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MLP.save_chain"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.save_chain">[docs]</a>    <span class="k">def</span> <span class="nf">save_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;chain_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;chain-</span><span class="si">%s</span><span class="s1">_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">savenpy</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/chains&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MLP.save_hparams"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.save_hparams">[docs]</a>    <span class="k">def</span> <span class="nf">save_hparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;hparams_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;hparams-</span><span class="si">%s</span><span class="s1">_nodes</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">savenpy</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/hparams&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnIn_step</span><span class="p">])</span></div>
    
<div class="viewcode-block" id="MLP.plot_loss"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MLP.plot_loss">[docs]</a>    <span class="k">def</span> <span class="nf">plot_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="RePredictMLP"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMLP">[docs]</a><span class="k">class</span> <span class="nc">RePredictMLP</span><span class="p">(</span><span class="n">MLP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repredict cosmological parameters using the saved networks.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path of the results saved. Default: &#39;ann&#39;</span>
<span class="sd">    randn_num : str or int</span>
<span class="sd">        A random number that identifies the saved results.</span>
<span class="sd">    params_dict : dict or None, optional</span>
<span class="sd">        Information of cosmological parameters that include the labels, the base values, the minimum values, </span>
<span class="sd">        and the maximum values. See :func:`~.cosmic_params.params_dict_zoo`. Default: None</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    norm_inputs : bool, optional</span>
<span class="sd">        If True, the input data of the network will be normalized. Default: True</span>
<span class="sd">    norm_target : bool, optional</span>
<span class="sd">        If True, the target data (cosmological parameters) will be normalized. Default: True</span>
<span class="sd">    norm_type : str, optional</span>
<span class="sd">        The method of normalization, &#39;z_score&#39;, &#39;minmax&#39;, or &#39;mean&#39; (see :class:`~.data_processor.Normalize`). Default: &#39;z_score&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="s1">&#39;0.123&#39;</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span> <span class="o">=</span> <span class="n">params_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">=</span> <span class="s1">&#39;z_score&#39;</span>
    
<div class="viewcode-block" id="RePredictMLP.load_net"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMLP.load_net">[docs]</a>    <span class="k">def</span> <span class="nf">load_net</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="RePredictMLP.load_loss"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMLP.load_loss">[docs]</a>    <span class="k">def</span> <span class="nf">load_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RePredictMLP.load_chain"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMLP.load_chain">[docs]</a>    <span class="k">def</span> <span class="nf">load_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/chains&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="RePredictMLP.load_hparams"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMLP.load_hparams">[docs]</a>    <span class="k">def</span> <span class="nf">load_hparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/hparams&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnIn_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<span class="c1">#%% multibranch network</span>
<div class="viewcode-block" id="MultiBranchNet"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet">[docs]</a><span class="k">class</span> <span class="nc">MultiBranchNet</span><span class="p">(</span><span class="n">MLP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multibranch network that is used to predict cosmological parameters with multiple sets of datasets.</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectra : list</span>
<span class="sd">        Simulated observational spectra (data), it is a list spectra with shape [(N,spectra_length_1), (N,spectra_length_2), ...].</span>
<span class="sd">    parameters : array-like</span>
<span class="sd">        The simulated parameters of a specific cosmological (or theoretical) model.</span>
<span class="sd">    param_names : list</span>
<span class="sd">        A list which contains the parameter names, e.g. [&#39;H0&#39;,&#39;Omega_m&#39;,&#39;ombh2&#39;,&#39;omch2&#39;,&#39;tau&#39;,&#39;As&#39;,&#39;ns&#39;].</span>
<span class="sd">    params_dict : dict or None, optional</span>
<span class="sd">        Information of cosmological parameters that include the labels, the base values, the minimum values, </span>
<span class="sd">        and the maximum values. See :func:`~.cosmic_params.params_dict_zoo`. Default: None</span>
<span class="sd">    obs_errors : list, optional</span>
<span class="sd">        Observational errors, it is a list of errors with shape [(spectra_length_1,), (spectra_length_2,), ...]. Default: None</span>
<span class="sd">    cov_matrix : list or None, optional</span>
<span class="sd">        A list of covariance matrix with shape [(spectra_length_1, spectra_length_1), (spectra_length_2, spectra_length_2), ...].</span>
<span class="sd">        If there is no covariance for some observations, the covariance matrix should be set to None. e.g. [cov_matrix_1, None, cov_matrix_3]. Default: None</span>
<span class="sd">    branch_hiddenLayer : int, optional</span>
<span class="sd">        The number of the hidden layer for the branch part of the network. Default: 2</span>
<span class="sd">    trunk_hiddenLayer : int, optional</span>
<span class="sd">        The number of the hidden layer for the trunk part of the network. Default: 1</span>
<span class="sd">    hp_model : str, optional</span>
<span class="sd">        Hyperparameter model that contains hyperparameters (such as activation function, batch normalization, dropout, etc.) used in the network.</span>
<span class="sd">        It can be &#39;eco_1&#39;, &#39;eco_2&#39;, &#39;eco_3&#39;, &#39;eco_4&#39;, &#39;eco_5&#39;, &#39;eco_6&#39;, or &#39;eco_7&#39; (see :func:`~.hpmodel.models`). Default: &#39;eco_3&#39;</span>
<span class="sd">    loss_func : str, optional</span>
<span class="sd">        The loss function used in the network. Default: &#39;L1&#39;</span>
<span class="sd">    noise_type : str, optional</span>
<span class="sd">        The type of Gaussian noise added to the training set, &#39;singleSigma&#39; or &#39;multiSigma&#39;. Default: &#39;multiSigma&#39;</span>
<span class="sd">    noise_sigma : float, optional</span>
<span class="sd">        For the case of &#39;singleSigma&#39;, it is the standard deviation of the Gaussian noise, while for the case of &#39;multiSigma&#39; it is </span>
<span class="sd">        a coefficient of the standard deviation. Default: 0.5</span>
<span class="sd">    multi_noise : int, optional</span>
<span class="sd">        The number of realization of noise added to a spectrum. Default: 5</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    lr : float, optional</span>
<span class="sd">        The learning rate setting of the network. Default: 1e-2</span>
<span class="sd">    lr_branch : float, optional</span>
<span class="sd">        The learning rate setting of the branch part. Default: 1e-2</span>
<span class="sd">    lr_min : float, optional</span>
<span class="sd">        The minimum of the learning rate. Default: 1e-8</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        The batch size setting of the network. Default: 750</span>
<span class="sd">    auto_batchSize : bool, optional</span>
<span class="sd">        If True, the batch size will be set automatically in the training process, otherwise, use the setting of ``batch_size``. Default: True</span>
<span class="sd">    epoch : int, optional</span>
<span class="sd">        The number of epoch of the training process. Default: 2000</span>
<span class="sd">    epoch_branch : int, optional</span>
<span class="sd">        The number of epoch for the branch part. This only works when training the branch part. Default: 2000</span>
<span class="sd">    base_epoch : int, optional</span>
<span class="sd">        The base number (or the minimum number) of epoch. Default: 1000</span>
<span class="sd">    auto_epoch : bool, optional</span>
<span class="sd">        If True, the epoch will be set automatically in the training process, otherwise, use the setting of ``epoch``. Default: True</span>
<span class="sd">    norm_inputs : bool, optional</span>
<span class="sd">        If True, the input data of the network will be normalized. Default: True</span>
<span class="sd">    norm_target : bool, optional</span>
<span class="sd">        If True, the target data (cosmological parameters) will be normalized. Default: True</span>
<span class="sd">    norm_type : str, optional</span>
<span class="sd">        The method of normalization, &#39;z_score&#39;, &#39;minmax&#39;, or &#39;mean&#39; (see :class:`~.data_processor.Normalize`). Default: &#39;z_score&#39;</span>
<span class="sd">    spaceSigma_min : int, optional</span>
<span class="sd">        The minimum parameter space to be learned, e.g. for spaceSigma_min=5, the parameter space to be learned is :math:`[-5\sigma, +5\sigma]`. Default: 5</span>
<span class="sd">    transfer_learning : bool, optional</span>
<span class="sd">        If True, the network will be initialized using the well-trained network of the previous step. Default: False</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    It is suggested to set lr and lr_branch the same value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obs_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">branch_hiddenLayer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunk_hiddenLayer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hp_model</span><span class="o">=</span><span class="s1">&#39;eco_3&#39;</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span>
                 <span class="n">noise_type</span><span class="o">=</span><span class="s1">&#39;multiSigma&#39;</span><span class="p">,</span> <span class="n">noise_sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">multi_noise</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1">#data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParamsScaling</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="n">params_dict</span><span class="p">)</span><span class="o">.</span><span class="n">scaling</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span> <span class="o">=</span> <span class="n">params_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_errors</span><span class="p">(</span><span class="n">obs_errors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov_matrix</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
        <span class="c1">#ANN model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branch_hiddenLayer</span> <span class="o">=</span> <span class="n">branch_hiddenLayer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trunk_hiddenLayer</span> <span class="o">=</span> <span class="n">trunk_hiddenLayer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp_model</span> <span class="o">=</span> <span class="n">hp_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">loss_funcs</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">loss_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_branch</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">750</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_batchSize</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_epoch</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_epoch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_initialize</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_info</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#data preprocessing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span> <span class="o">=</span> <span class="n">noise_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span> <span class="o">=</span> <span class="n">noise_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span> <span class="o">=</span> <span class="n">multi_noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">=</span> <span class="s1">&#39;z_score&#39;</span>
        <span class="c1">#training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spaceSigma_min</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_repeat_n</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">burn_in</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">burnIn_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_learning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span><span class="o">/</span><span class="mf">5.</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_obs_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">errors</span>
    
    <span class="k">def</span> <span class="nf">_cov_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matrix</span>
    
    <span class="k">def</span> <span class="nf">_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">_net</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_initialize</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="c1">#Fixed parameter initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hparams</span> <span class="o">=</span> <span class="n">hpmodel</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp_model</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
            <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;self.branch_net</span><span class="si">%s</span><span class="s1">=fcnet.get_FcNet(node_in=self.nodes_in[i], node_out=self.node_out,</span><span class="se">\</span>
<span class="s1">            hidden_layer=2*self.branch_hiddenLayer+1, hparams=self.hparams)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">fcnet</span><span class="o">.</span><span class="n">get_MultiBranchFcNet</span><span class="p">(</span><span class="n">nodes_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_in</span><span class="p">,</span> <span class="n">node_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_out</span><span class="p">,</span> <span class="n">branch_hiddenLayer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_hiddenLayer</span><span class="p">,</span>
                                              <span class="n">trunk_hiddenLayer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trunk_hiddenLayer</span><span class="p">,</span> <span class="n">nodes_all</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hparams</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_info</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span>
    
<div class="viewcode-block" id="MultiBranchNet.transfer_branchNet"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.transfer_branchNet">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_branchNet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;self.branch_net</span><span class="si">%s</span><span class="s1"> = self.branch_net</span><span class="si">%s</span><span class="s1">.cuda(device)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">))</span></div>
    
    <span class="k">def</span> <span class="nf">_copyLayer_fromBranch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">branch_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Copying hyperparameters of the branch networks to the multibranch network&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_hiddenLayer</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.net.branch</span><span class="si">%s</span><span class="s1">[j*3].load_state_dict(self.branch_net</span><span class="si">%s</span><span class="s1">.fc[j*3].state_dict())&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span><span class="c1">#copy Linear</span>
                    <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.net.branch</span><span class="si">%s</span><span class="s1">[j*3+1].load_state_dict(self.branch_net</span><span class="si">%s</span><span class="s1">.fc[j*3+1].state_dict())&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span><span class="c1">#copy BN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Copying hyperparameters of the branch network </span><span class="si">{}</span><span class="s1"> to the multibranch network</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch_index</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_hiddenLayer</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.net.branch</span><span class="si">%s</span><span class="s1">[j*3].load_state_dict(self.branch_net</span><span class="si">%s</span><span class="s1">.fc[j*3].state_dict())&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">branch_index</span><span class="p">,</span> <span class="n">branch_index</span><span class="p">))</span><span class="c1">#copy Linear</span>
                <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.net.branch</span><span class="si">%s</span><span class="s1">[j*3+1].load_state_dict(self.branch_net</span><span class="si">%s</span><span class="s1">.fc[j*3+1].state_dict())&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">branch_index</span><span class="p">,</span> <span class="n">branch_index</span><span class="p">))</span><span class="c1">#copy BN</span>
    
<div class="viewcode-block" id="MultiBranchNet.statistic"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.statistic">[docs]</a>    <span class="k">def</span> <span class="nf">statistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="MultiBranchNet.transfer_data"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.transfer_data">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2cuda</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<span class="c1">#    def transfer_subData(self, device=None):</span>
<span class="c1">#        if self.use_GPU:</span>
<span class="c1">#            self.inputs = dp.numpy2cuda(self.inputs, device=device)</span>
<span class="c1">#            self.target = dp.numpy2cuda(self.target, device=device)</span>
<span class="c1">#            self.error = dp.numpy2cuda(self.error, device=device)</span>
<span class="c1">#        else:</span>
<span class="c1">#            self.inputs = dp.numpy2torch(self.inputs)</span>
<span class="c1">#            self.target = dp.numpy2torch(self.target)</span>
<span class="c1">#            self.error = dp.numpy2torch(self.error)</span>
    
    <span class="k">def</span> <span class="nf">_train_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">repeat_n</span><span class="p">,</span> <span class="n">showIter_n</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.branch_net</span><span class="si">%s</span><span class="s1">.parameters()&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_branch</span><span class="p">)</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">repeat_n</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span>
<span class="c1">#        self.transfer_subData(device=device)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training the branch network </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subsample_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">_inputs</span><span class="p">,</span> <span class="n">_target</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">AddMultiGaussianNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span><span class="n">obs_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span><span class="n">cov_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_m</span><span class="p">,</span><span class="n">multi_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="p">,</span><span class="n">use_GPU</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">)</span><span class="o">.</span><span class="n">multiNoisySample</span><span class="p">(</span><span class="n">noise_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span><span class="p">,</span><span class="n">reorder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span><span class="p">:</span>
                <span class="n">_inputs</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">[</span><span class="n">rank</span><span class="p">],</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span><span class="p">:</span>
                <span class="n">_target</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">iter_mid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_inputs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="n">_inputs</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">_target</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="n">_predicted</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.branch_net</span><span class="si">%s</span><span class="s1">(xx)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">_predicted</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                
            <span class="k">if</span> <span class="n">subsample_num</span><span class="o">%</span><span class="n">showIter_n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(epoch:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">; loss:</span><span class="si">%.5f</span><span class="s1">; lr:</span><span class="si">%.8f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span> <span class="n">_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]))</span>
            <span class="n">lrdc</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LrDecay</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span><span class="n">iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_branch</span><span class="p">,</span><span class="n">lr_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrdc</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        
        <span class="c1">#############################################################################</span>
        <span class="c1"># Note: hyperparameters must be transferred in the subprocess.</span>
        <span class="c1">#</span>
        <span class="c1"># Variables defined in the subprocess can not be called by the main process,</span>
        <span class="c1"># but, the hyperparameters of &quot;self.branch_net%s&quot;%i can be copied to &quot;self.net&quot;,</span>
        <span class="c1"># the reason may be that hyperparameters of the network shared the memory.</span>
        <span class="c1">#############################################################################</span>
        <span class="c1">#print(eval(&quot;self.branch_net%s.fc[3].state_dict()[&#39;bias&#39;][:5]&quot;%(rank+1)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copyLayer_fromBranch</span><span class="p">(</span><span class="n">branch_index</span><span class="o">=</span><span class="n">rank</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_train_branchNet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">showIter_n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1">#############################################################################</span>
        <span class="c1"># Note: variables used in the subprocess (in the function self._train_branch)</span>
        <span class="c1">#       should be defined before using &quot;mp.spawn&quot;, and variables defined in the</span>
        <span class="c1">#       subprocess can not be called by the main process.</span>
        <span class="c1">#</span>
        <span class="c1"># # the following lines have the same function as &quot;mp.spawn&quot;</span>
        <span class="c1"># mp.set_start_method(&#39;spawn&#39;) #this is important</span>
        <span class="c1"># processes = []</span>
        <span class="c1"># for rank in range(self.branch_n):</span>
        <span class="c1">#     p = mp.Process(target=self._train_branch, args=(rank, repeat_n, showIter_n, device))</span>
        <span class="c1">#     p.start()</span>
        <span class="c1">#     processes.append(p)</span>
        <span class="c1"># for p in processes:</span>
        <span class="c1">#     p.join()</span>
        <span class="c1">#############################################################################</span>
        
        <span class="c1">#this means that the branch networks can only be trained on 1 GPU, how to train them on muliple GPUs?</span>
        <span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1">#Note: all networks should be transfered to GPU when using &quot;mp.spawn&quot; to train the branch networks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_branchNet</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_branch</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">repeat_n</span><span class="p">,</span> <span class="n">showIter_n</span><span class="p">,</span> <span class="n">device</span><span class="p">),</span> <span class="n">join</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_train_trunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">showIter_n</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fix_lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">reduce_fix_lr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">branch_p</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">branch_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;{&#39;params&#39;:self.net.branch</span><span class="si">%s</span><span class="s2">.parameters(), &#39;lr&#39;:fix_lr}&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span> <span class="c1">#lr=fix_lr</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">branch_p</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">trunk</span><span class="o">.</span><span class="n">parameters</span><span class="p">()}],</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training the trunk network&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subsample_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">AddMultiGaussianNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">obs_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">,</span><span class="n">cov_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span><span class="n">multi_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="p">,</span><span class="n">use_GPU</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">)</span><span class="o">.</span><span class="n">multiNoisySample</span><span class="p">(</span><span class="n">noise_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span><span class="p">,</span><span class="n">reorder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">iter_mid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">batch_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="n">_predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">_predicted</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                
            <span class="k">if</span> <span class="n">subsample_num</span><span class="o">%</span><span class="n">showIter_n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(epoch:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">; loss:</span><span class="si">%.5f</span><span class="s1">; lr_branch:</span><span class="si">%.8f</span><span class="s1">; lr_trunk:</span><span class="si">%.8f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span> <span class="n">_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]))</span>
            <span class="n">lrdc_t</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LrDecay</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span><span class="n">iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span><span class="n">lr_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrdc_t</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
            <span class="c1">#test</span>
            <span class="k">if</span> <span class="n">reduce_fix_lr</span><span class="p">:</span>
                <span class="n">lrdc_b</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LrDecay</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span><span class="n">iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="n">fix_lr</span><span class="p">,</span><span class="n">lr_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span><span class="c1">#change to lr=self.lr ?</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
                    <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrdc_b</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
    
    
<div class="viewcode-block" id="MultiBranchNet.train"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat_n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">showIter_n</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">train_branch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">train_trunk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">reduce_fix_lr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_net</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_learning</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">train_branch</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyLayers_fromTrainedNet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_net</span><span class="p">(</span><span class="n">prints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">print_info</span><span class="p">)</span>
        
        <span class="c1">#branch_p = [eval(&quot;{&#39;params&#39;:self.net.branch%s.parameters(), &#39;lr&#39;:self.lr_branch}&quot;%i) for i in range(1,self.branch_n+1)] #this will raise an error in python3.X</span>
        <span class="c1">#however, the following lines run well for both python2.X and python3.X, why?</span>
        <span class="n">branch_p</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">branch_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;{&#39;params&#39;:self.net.branch</span><span class="si">%s</span><span class="s2">.parameters(), &#39;lr&#39;:self.lr_branch}&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">branch_p</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">trunk</span><span class="o">.</span><span class="n">parameters</span><span class="p">()}],</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
        
        <span class="c1">#added</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_batchSize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_batchSize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_batchSize</span><span class="p">()</span>
        <span class="c1"># print(&#39;batch size: %s&#39;%self.batch_size)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_epoch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_auto_epoch</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_repeat_n</span><span class="p">:</span>
            <span class="n">repeat_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_repeat_n</span><span class="p">(</span><span class="n">repeat_n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">repeat_n</span>
        <span class="c1"># print(&#39;repeat_n:%s&#39;%repeat_n)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_data</span><span class="p">()</span>
        
        <span class="c1"># np.random.seed(1000)#</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;randn_num: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">train_branch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_train_branchNet</span><span class="p">(</span><span class="n">repeat_n</span><span class="o">=</span><span class="n">repeat_n</span><span class="p">,</span> <span class="n">showIter_n</span><span class="o">=</span><span class="n">showIter_n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer_branchNet</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_train_branch</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">repeat_n</span><span class="p">,</span> <span class="n">showIter_n</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">train_trunk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_trunk</span><span class="p">(</span><span class="n">repeat_n</span><span class="o">=</span><span class="n">repeat_n</span><span class="p">,</span> <span class="n">showIter_n</span><span class="o">=</span><span class="n">showIter_n</span><span class="p">,</span> <span class="n">fix_lr</span><span class="o">=</span><span class="n">fix_lr</span><span class="p">,</span> <span class="n">reduce_fix_lr</span><span class="o">=</span><span class="n">reduce_fix_lr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Training the multibranch network&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subsample_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">AddMultiGaussianNoise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span><span class="n">obs_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_errors</span><span class="p">,</span><span class="n">cov_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span><span class="n">multi_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_noise</span><span class="p">,</span><span class="n">use_GPU</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_GPU</span><span class="p">)</span><span class="o">.</span><span class="n">multiNoisySample</span><span class="p">(</span><span class="n">noise_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_type</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span><span class="p">,</span><span class="n">reorder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">iter_mid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">batch_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">batch_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span>
                <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">)]</span>
                <span class="n">yy</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="n">_predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">_predicted</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
                
            <span class="k">if</span> <span class="n">subsample_num</span><span class="o">%</span><span class="n">showIter_n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_branch</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(epoch:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">; loss:</span><span class="si">%.5f</span><span class="s1">; lr:</span><span class="si">%.8f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(epoch:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">; loss:</span><span class="si">%.5f</span><span class="s1">; lr_branch:</span><span class="si">%.8f</span><span class="s1">; lr_trunk:</span><span class="si">%.8f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]))</span>
            <span class="n">lrdc_t</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LrDecay</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span><span class="n">iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span><span class="n">lr_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrdc_t</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
            <span class="n">lrdc_b</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LrDecay</span><span class="p">(</span><span class="n">subsample_num</span><span class="p">,</span><span class="n">iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_branch</span><span class="p">,</span><span class="n">lr_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr_min</span><span class="p">)</span><span class="c1">#change to lr=self.lr ?</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lrdc_b</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span></div>
    
    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="c1"># in_type: &#39;numpy&#39; or &#39;torch&#39;</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span> <span class="c1">#this works for the batch normalization layers</span>
        <span class="k">if</span> <span class="n">in_type</span><span class="o">==</span><span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">))]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Variable</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">))]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">torch2numpy</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred</span>
    
<div class="viewcode-block" id="MultiBranchNet.predict"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
        <span class="c1"># spectra: [spectra1, spectra2, ...]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">))]</span> <span class="c1">#for one spectrum</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span><span class="p">:</span>
            <span class="n">spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">spectra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">))]</span>
        <span class="n">pred_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">,</span> <span class="n">spectra</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="n">in_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">InverseNormalize</span><span class="p">(</span><span class="n">pred_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="n">norm_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span><span class="p">)</span><span class="o">.</span><span class="n">inverseNorm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">ParamsScaling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span><span class="p">)</span><span class="o">.</span><span class="n">inverseScaling</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_params</span></div>
    
<div class="viewcode-block" id="MultiBranchNet.predict_chain"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.predict_chain">[docs]</a>    <span class="k">def</span> <span class="nf">predict_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_spectra</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain_leng</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="c1"># obs_spectra: observational spectrum in a list [spectra1, spectra2, ...], each element has shape (N, 3)</span>
        <span class="c1"># torch.manual_seed(1000)#</span>
        <span class="k">if</span> <span class="n">cov_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">))]</span>
        <span class="n">obs_spectra</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">))]</span>
        <span class="n">obs_best</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">))]</span>
        <span class="n">obs_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_spectra</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">))]</span>
        <span class="n">obs_best_multi</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">chain_leng</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_best</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="o">*</span> <span class="n">obs_best</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_spectra</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">numpy2torch</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">obs_best_multi</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">AddGaussianNoise</span><span class="p">(</span><span class="n">obs_best_multi</span><span class="p">,</span> <span class="n">obs_errors</span><span class="o">=</span><span class="n">obs_errors</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">=</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">use_GPU</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">singleSigma</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">obs_best_multi</span><span class="p">,</span> <span class="n">in_type</span><span class="o">=</span><span class="s1">&#39;torch&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span></div>
    
<div class="viewcode-block" id="MultiBranchNet.save_net"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.save_net">[docs]</a>    <span class="k">def</span> <span class="nf">save_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;TT&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;net_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pt&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;net-</span><span class="si">%s</span><span class="s1">_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.pt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">saveTorchPt</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="MultiBranchNet.save_loss"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.save_loss">[docs]</a>    <span class="k">def</span> <span class="nf">save_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;TT&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;loss_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;loss-</span><span class="si">%s</span><span class="s1">_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">savenpy</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MultiBranchNet.save_chain"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.save_chain">[docs]</a>    <span class="k">def</span> <span class="nf">save_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;TT&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;chain_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;chain-</span><span class="si">%s</span><span class="s1">_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">savenpy</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/chains&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MultiBranchNet.save_hparams"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.MultiBranchNet.save_hparams">[docs]</a>    <span class="k">def</span> <span class="nf">save_hparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;TT&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;hparams_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s1">&#39;hparams-</span><span class="si">%s</span><span class="s1">_branch</span><span class="si">%s</span><span class="s1">_train</span><span class="si">%s</span><span class="s1">_batch</span><span class="si">%s</span><span class="s1">_epoch</span><span class="si">%s</span><span class="s1">_epochBranch</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_branch</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">savenpy</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/hparams&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnIn_step</span><span class="p">])</span></div></div>

<div class="viewcode-block" id="RePredictMBNet"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMBNet">[docs]</a><span class="k">class</span> <span class="nc">RePredictMBNet</span><span class="p">(</span><span class="n">MultiBranchNet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repredict cosmological parameters using the saved networks.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path of the results saved. Default: &#39;ann&#39;</span>
<span class="sd">    randn_num : str or int</span>
<span class="sd">        A random number that identifies the saved results.</span>
<span class="sd">    params_dict : dict or None, optional</span>
<span class="sd">        Information of cosmological parameters that include the labels, the base values, the minimum values, </span>
<span class="sd">        and the maximum values. See :func:`~.cosmic_params.params_dict_zoo`. Default: None</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    norm_inputs : bool, optional</span>
<span class="sd">        If True, the input data of the network will be normalized. Default: True</span>
<span class="sd">    norm_target : bool, optional</span>
<span class="sd">        If True, the target data (cosmological parameters) will be normalized. Default: True</span>
<span class="sd">    norm_type : str, optional</span>
<span class="sd">        The method of normalization, &#39;z_score&#39;, &#39;minmax&#39;, or &#39;mean&#39; (see :class:`~.data_processor.Normalize`). Default: &#39;z_score&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;ann&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="s1">&#39;0.123&#39;</span><span class="p">,</span> <span class="n">params_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">randn_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_dict</span> <span class="o">=</span> <span class="n">params_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_inputs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_target</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_type</span> <span class="o">=</span> <span class="s1">&#39;z_score&#39;</span>
    
<div class="viewcode-block" id="RePredictMBNet.load_net"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMBNet.load_net">[docs]</a>    <span class="k">def</span> <span class="nf">load_net</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="RePredictMBNet.load_loss"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMBNet.load_loss">[docs]</a>    <span class="k">def</span> <span class="nf">load_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/net&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="RePredictMBNet.load_chain"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMBNet.load_chain">[docs]</a>    <span class="k">def</span> <span class="nf">load_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/chains&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RePredictMBNet.load_hparams"><a class="viewcode-back" href="../../ann_models.html#ecopann.models.RePredictMBNet.load_hparams">[docs]</a>    <span class="k">def</span> <span class="nf">load_hparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">FilePath</span><span class="p">(</span><span class="n">filedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/hparams&#39;</span><span class="p">,</span> <span class="n">randn_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">randn_num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectra_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_statistic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">burnIn_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>

<span class="c1">#!!!</span>
<span class="c1"># 1. check how to reduce training time, when using multi_noise</span>
<span class="c1"># 2. for unilateral distribution, the result is not good, try to solve this</span>
<span class="c1"># 3. whether to use transfer learning?</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Guojian Wang

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>